{% extends "portal/base.html" %}
{% block title %}Comptabilité — {{ company.name }}{% endblock %}
{% block content %}
<div class="page">
  <h1 class="page-title">Comptabilité — {{ company.name }}</h1>

  <!-- Bandeau statut (conserve l'existant) -->
  <div class="card shadow-md mb-4">
    <div class="card-body">
      <strong>Statut :</strong> {{ company.display_status }} ·
      <strong>Périodicité URSSAF :</strong> {{ company.get_urssaf_frequency_display }} ·
      <strong>Activité :</strong> {{ company.get_activity_kind_display }}
    </div>
  </div>

  <!-- Synthèse -->
  <div class="grid grid-3 gap">
    <div class="card shadow-md">
      <div class="card-header">CA cumulé {{ year }}</div>
      <div class="card-body">
        <div class="kpi">{{ ca_ytd }} €</div>
        <div>Plafond micro : {{ micro_cap }} €</div>
        <div class="progress">
          <div class="bar" style="width: '{{ micro_progress }}%'"></div>
        </div>
        <div class="muted">{{ micro_progress }} % du plafond</div>
      </div>
    </div>

    <div class="card shadow-md">
      <div class="card-header">Franchise en base de TVA</div>
      <div class="card-body">
        <div>Seuil base : <strong>{{ vat_base }} €</strong></div>
        <div>Seuil tolérance : <strong>{{ vat_tol }} €</strong></div>
        {% if ca_ytd|default:0 >= vat_base %}
          <div class="alert warn mt-2">
            Seuil de base atteint — surveille la tolérance. (Réf. Service-Public)
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-md">
      <div class="card-header">URSSAF — période en cours</div>
      <div class="card-body">
        <div>Période: {{ period_start }} → {{ period_end }}</div>
        <div>CA période : <strong>{{ period_ca }} €</strong></div>
        <div>Taux estimatif : <strong>{{ urssaf_rate_label }}</strong></div>
        <div>Cotisations estimées : <strong>{{ contrib }} €</strong></div>
        <a class="btn btn-primary mt-2" href="{% url 'portal:urssaf_pdf' %}">Générer le PDF URSSAF</a>
      </div>
    </div>
  </div>

  <!-- Filtre / export -->
  <div class="card shadow-md mt-4">
    <div class="card-body">
      <form method="get" class="flex flex-wrap gap-3 items-end">
        <div>
          <label class="block text-sm">Date début</label>
          <input type="date" name="start_date" value="{{ start_date }}" class="field-sm">
        </div>
        <div>
          <label class="block text-sm">Date fin</label>
          <input type="date" name="end_date" value="{{ end_date }}" class="field-sm">
        </div>
        <div>
          <label class="block text-sm">Client</label>
          <select name="client" class="field-sm">
            <option value="">Tous</option>
            {% for c in clients %}
              <option value="{{ c.id }}" {% if client_filter and client_filter == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <button type="submit" class="btn btn-primary">Filtrer</button>
          <a href="?export=csv{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if client_filter %}&client={{ client_filter }}{% endif %}" class="btn btn-outline ml-2">Exporter CSV</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Graphique -->
  <div class="card shadow-md mt-4">
    <div class="card-header">Progression du CA ({{ year }})</div>
    <div class="card-body">
      <canvas id="caChart"></canvas>
    </div>
  </div>

  <!-- Table des factures -->
  <div class="card shadow-md mt-4">
    <div class="card-header">Factures (affichage limité)</div>
    <div class="card-body">
      <table class="table w-full">
        <thead>
          <tr>
            <th>Facture</th>
            <th>Date</th>
            <th>Client</th>
            <th class="right">Total HT</th>
            <th class="right">TVA</th>
            <th class="right">Total TTC</th>
            <th class="right">Statut</th>
          </tr>
        </thead>
        <tbody>
          {% for inv in invoices %}
            <tr>
              <td><a href="{% url 'portal:invoice_edit' inv.pk %}">{{ inv.number }}</a></td>
              <td>{{ inv.issue_date }}</td>
              <td>{% if inv.customer %}{{ inv.customer.name }}{% endif %}</td>
              <td class="right">
                {% if inv.total_ht %}{{ inv.total_ht|floatformat:2 }} €{% else %}-{% endif %}
              </td>
              <td class="right">
                {% if inv.total_vat %}{{ inv.total_vat|floatformat:2 }} €{% else %}-{% endif %}
              </td>
              <td class="right">
                {% if inv.total_ttc %}{{ inv.total_ttc|floatformat:2 }} €{% else %}-{% endif %}
              </td>
              <td class="right">{{ inv.status }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="7" class="muted">Aucune facture pour les critères indiqués.</td></tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- pagination simple -->
      <div class="mt-3 flex justify-between items-center">
        <div class="muted">Page {{ page }}</div>
        <div>
          {% if page > 1 %}
            <a class="btn btn-outline" href="?page={{ page|add:"-1" }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if client_filter %}&client={{ client_filter }}{% endif %}">Précédent</a>
          {% endif %}
          <a class="btn btn-outline" href="?page={{ page|add:"1" }}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if client_filter %}&client={{ client_filter }}{% endif %}">Suivant</a>
        </div>
      </div>

      <div class="mt-4 text-right">
        <div>Sous-total HT : <strong>{{ subtotal|floatformat:2 }} €</strong></div>
        <div>TVA totale : <strong>{{ vat_total|floatformat:2 }} €</strong></div>
        <div>Total TTC : <strong>{{ total_ttc|floatformat:2 }} €</strong></div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function(){
  const labels = ["Jan","Fév","Mar","Avr","Mai","Juin","Juil","Août","Sep","Oct","Nov","Déc"];
  const ytd = Number({{ ca_ytd|default:0 }});
  const monthIndex = (new Date()).getMonth();
  const data = [];
  for (let i=0;i<12;i++){
    data.push(i<=monthIndex ? Math.round(ytd*(i+1)/(monthIndex+1)) : null);
  }
  const ctx = document.getElementById('caChart');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'CA cumulé',
        data,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,0.08)',
        tension: 0.2
      },{
        label: 'Plafond micro',
        data: labels.map(_=> {{ micro_cap|default:0 }}),
        borderColor: '#f97316',
        borderDash: [5,5],
        tension: 0.2
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
})();
</script>

<style>
/* Conservé et ajusté */
.grid { display:grid; gap:1rem; }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.card { background:#fff; border-radius:12px; border:1px solid #e9eef5; }
.card-header { font-weight:600; padding:0.75rem 1rem; border-bottom:1px solid #eef2f7; }
.card-body { padding:1rem; }
.shadow-md { box-shadow:0 6px 24px rgba(0,40,120,.07); }
.kpi { font-size:1.6rem; font-weight:700; }
.muted { color:#6b7280; font-size:.9rem; }
.progress { background:#f3f4f6; border-radius:8px; height:10px; margin-top:.5rem; }
.progress .bar { background:#2563eb; height:10px; border-radius:8px; }
.alert.warn { background:#fff8e1; border:1px solid #fde68a; padding:.5rem .75rem; border-radius:8px; }
.page-title { margin-bottom:.5rem }
.btn { display:inline-block; padding:.5rem .75rem; border-radius:8px; text-decoration:none; }
.btn-primary { background:#2563eb; color:#fff; }
.btn-outline { border:1px solid #e2e8f0; padding:.45rem .65rem; border-radius:8px; color:#111; background:transparent; }
.table { width:100%; border-collapse: collapse; }
.table th, .table td { padding: .6rem .5rem; border-bottom: 1px solid #eef2f7; text-align: left; }
.table th.right, .table td.right { text-align: right; }
@media (max-width: 980px){ .grid-3 { grid-template-columns: 1fr; } }
</style>
{% endblock %}
