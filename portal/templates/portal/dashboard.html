{% extends "portal/base.html" %}
{% load static %}
{% load portal_extras %}

{% block title %}Dashboard — {{ company.name }}{% endblock %}

{% block content %}
<div class="p-6 space-y-6">
  <h2 class="text-lg font-semibold">Dashboard — Bonjour, {{ request.user.get_full_name|default:request.user.username }}</h2>

  <!-- KPIs -->
<div id="dashboard-kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">

  {% include "portal/components/kpi.html" with
      title="Trésorerie (est.) 30j"
      value=cash_balance|money
      value_raw=cash_balance
      meta="Prévision"
      state="success"
      tooltip="Somme des entrées/sorties (Turnover) sur 30 jours" %}

  {% include "portal/components/kpi.html" with
      title="CA mois"
      value=ca_month|money
      value_raw=ca_month
      meta="Mois courant"
      state="success"
      tooltip="Somme des factures émises ce mois" %}

  {% include "portal/components/kpi.html" with
      title="Factures impayées"
      value=invoices_open_total|money
      value_raw=invoices_open_total
      meta="Total ouvert"
      state="warn"
      tooltip="Total des factures au statut 'ISSUED'" %}

  {% include "portal/components/kpi.html" with
      title="Clients >30j"
      value=clients_over_30
      value_raw=clients_over_30
      meta="clients débiteurs"
      state="danger"
      tooltip="Clients dont au moins une facture est >30j d’échéance" %}
</div>


  <!-- Second row -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
    <!-- Aging -->
    <div class="bg-white rounded-2xl shadow-sm p-5">
      <div class="font-semibold mb-3">Aging (créances)</div>
      <table class="w-full text-sm">
        <tbody>
          <tr><td>0–30j</td><td class="text-right">{{ aging.0_30|default:0|money }}</td></tr>
          <tr><td>31–60j</td><td class="text-right">{{ aging.31_60|default:0|money }}</td></tr>
          <tr><td>61–90j</td><td class="text-right">{{ aging.61_90|default:0|money }}</td></tr>
          <tr><td>> 90j</td><td class="text-right">{{ aging.gt_90|default:0|money }}</td></tr>
        </tbody>
      </table>
      <div class="mt-3 text-xs text-slate-500">Montants TTC approximatifs</div>
    </div>

    <!-- Factures récentes -->
    <div class="bg-white content-fade rounded-2xl shadow-sm p-5">
      <div class="font-semibold mb-3">Factures récentes</div>
      <div class="space-y-3 text-sm">
        {% for inv in recent_invoices %}
          <div class="flex items-center justify-between">
            <div>
              <a href="{% url 'portal:invoice_edit' inv.pk %}" class="font-medium hover:text-slate-700">{{ inv.number }}</a>
              <div class="text-xs text-slate-400">{{ inv.issue_date }}</div>
            </div>
            <div class="text-right">
              <div class="font-medium">{{ inv.computed_total|money }}</div>
              <div class="text-xs text-slate-400">{{ inv.status }}</div>
            </div>
          </div>
        {% empty %}
          <div class="text-center text-slate-500 py-6">
            <div class="mb-2">Aucune facture récente</div>
            <a class="inline-flex items-center px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50"
               href="{% url 'portal:invoice_new' %}">Créer une facture</a>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Top clients -->
    <div class="bg-white rounded-2xl shadow-sm p-5">
      <div class="font-semibold mb-3">Top clients (90j)</div>
      <ol class="text-sm list-decimal list-inside space-y-2">
        {% for c in top_customers %}
          <li class="flex justify-between">
            <div>{{ c.name|default:"(client)" }}</div>
            <div class="font-medium">{{ c.total|money }}</div>
          </li>
        {% empty %}
          <li class="text-slate-500">Aucun client (créez une facture pour commencer)</li>
        {% endfor %}
      </ol>
    </div>
  </div>

  <!-- Sparkline -->
  <div class="bg-white rounded-2xl shadow-sm p-5">
    <div class="font-semibold mb-3">CA 12 mois</div>
    <div style="height:160px;">
      <canvas id="caSpark" aria-label="Graphique du chiffre d’affaires sur 12 mois"></canvas>
    </div>
  </div>

  <!-- Actions rapides -->
  <div class="flex flex-wrap gap-3">
    <a class="btn btn-primary" href="{% url 'portal:invoice_new' %}">Créer une facture</a>
    <a class="btn btn-outline" href="{% url 'portal:quotes' %}">Créer un devis</a>
    <a class="btn btn-outline" href="{% url 'portal:accounting' %}">Ouvrir la Comptabilité complète</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script src="{% static 'js/dashboard-polish.js' %}"></script>
<script>
  window.DASHBOARD_CA_SERIES = {{ ca_series|safe }};
</script>
{% endblock %}
